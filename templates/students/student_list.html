{% extends 'base/base.html' %}
{% load static %}

{% block title %}Students - EduSight{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">Students Management</h1>
        <p class="page-subtitle">View and manage all student records</p>
    </div>
    <a href="/students/create/" class="btn btn-primary-custom">
        <i class="fas fa-plus me-2"></i>Add New Student
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card bg-primary">
            <div class="stats-number">{{ students.count|default:0 }}</div>
            <div class="stats-label">Total Students</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card bg-success">
            <div class="stats-number">{{ active_count|default:0 }}</div>
            <div class="stats-label">Active Students</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card bg-info">
            <div class="stats-number">{{ schools_count|default:0 }}</div>
            <div class="stats-label">Schools</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card bg-warning">
            <div class="stats-number">{{ avg_grade|default:0|floatformat:1 }}</div>
            <div class="stats-label">Average Grade</div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card-modern mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <input type="text" class="form-control" name="search" value="{{ request.GET.search }}" 
                       placeholder="Search by name, email, or roll number...">
            </div>
            <div class="col-md-3">
                <select class="form-select" name="school">
                    <option value="">All Schools</option>
                    {% for school in schools %}
                    <option value="{{ school.id }}" {% if request.GET.school == school.id|stringformat:"s" %}selected{% endif %}>
                        {{ school.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="grade">
                    <option value="">All Grades</option>
                    {% for grade in grades %}
                    <option value="{{ grade }}" {% if request.GET.grade == grade %}selected{% endif %}>
                        Grade {{ grade }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="status">
                    <option value="">All Status</option>
                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary-custom w-100">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Students Table -->
<div class="card-modern">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Student Records</h5>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-secondary btn-sm" onclick="exportData('csv')">
                <i class="fas fa-file-csv me-1"></i>CSV
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="exportData('pdf')">
                <i class="fas fa-file-pdf me-1"></i>PDF
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </div>
                        </th>
                        <th>Student</th>
                        <th>School</th>
                        <th>Grade</th>
                        <th>Roll Number</th>
                        <th>Status</th>
                        <th>Enrollment Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input student-checkbox" type="checkbox" value="{{ student.id }}">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar bg-primary text-white rounded-circle me-3" 
                                     style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                    {{ student.user.first_name|first|default:"U" }}{{ student.user.last_name|first|default:"" }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ student.user.get_full_name|default:student.user.username }}</div>
                                    <small class="text-muted">{{ student.user.email|default:"No email" }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">{{ student.school.name|default:"N/A" }}</span>
                        </td>
                        <td>
                            <span class="badge bg-info">Grade {{ student.grade|default:"N/A" }}</span>
                        </td>
                        <td>{{ student.roll_number|default:"Not assigned" }}</td>
                        <td>
                            {% if student.user.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ student.enrollment_date|date:"M d, Y"|default:"N/A" }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="/students/{{ student.id }}/" class="btn btn-sm btn-outline-info" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="/students/{{ student.id }}/edit/" class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent({{ student.id }})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No students found</h5>
                            <p class="text-muted">Start by adding your first student to the system.</p>
                            <a href="/students/create/" class="btn btn-primary-custom">
                                <i class="fas fa-plus me-2"></i>Add First Student
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="card-footer">
        <nav aria-label="Students pagination">
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.school %}&school={{ request.GET.school }}{% endif %}{% if request.GET.grade %}&grade={{ request.GET.grade }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.school %}&school={{ request.GET.school }}{% endif %}{% if request.GET.grade %}&grade={{ request.GET.grade }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Previous</a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.school %}&school={{ request.GET.school }}{% endif %}{% if request.GET.grade %}&grade={{ request.GET.grade }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.school %}&school={{ request.GET.school }}{% endif %}{% if request.GET.grade %}&grade={{ request.GET.grade }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Last</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Bulk Actions -->
<div class="card-modern mt-4" id="bulkActionsCard" style="display: none;">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="selectedCount">0</span> students selected
            </div>
            <div>
                <button class="btn btn-success me-2" onclick="bulkAction('activate')">
                    <i class="fas fa-check me-1"></i>Activate
                </button>
                <button class="btn btn-warning me-2" onclick="bulkAction('deactivate')">
                    <i class="fas fa-pause me-1"></i>Deactivate
                </button>
                <button class="btn btn-danger" onclick="bulkAction('delete')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.student-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
    const bulkCard = document.getElementById('bulkActionsCard');
    const selectedCount = document.getElementById('selectedCount');
    
    if (checkedBoxes.length > 0) {
        bulkCard.style.display = 'block';
        selectedCount.textContent = checkedBoxes.length;
    } else {
        bulkCard.style.display = 'none';
    }
}

// Add event listeners to individual checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
});

function deleteStudent(studentId) {
    if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
        // Create a form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/students/${studentId}/delete/`;
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="confirm" value="yes">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

function bulkAction(action) {
    const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
    const studentIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (studentIds.length === 0) {
        alert('Please select at least one student.');
        return;
    }
    
    let confirmMessage = '';
    switch(action) {
        case 'delete':
            confirmMessage = `Are you sure you want to delete ${studentIds.length} students? This action cannot be undone.`;
            break;
        case 'activate':
            confirmMessage = `Are you sure you want to activate ${studentIds.length} students?`;
            break;
        case 'deactivate':
            confirmMessage = `Are you sure you want to deactivate ${studentIds.length} students?`;
            break;
    }
    
    if (confirm(confirmMessage)) {
        // Create form for bulk action
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/students/bulk-action/';
        
        let inputs = `{% csrf_token %}<input type="hidden" name="action" value="${action}">`;
        studentIds.forEach(id => {
            inputs += `<input type="hidden" name="student_ids" value="${id}">`;
        });
        
        form.innerHTML = inputs;
        document.body.appendChild(form);
        form.submit();
    }
}

function exportData(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

// Auto-submit search form on input change with debounce
let searchTimeout;
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.form.submit();
            }, 500);
        });
    }
});
</script>
{% endblock %}